;(function(e,t,n){function o(t,n){this.element=t;this.options=e.extend({},s,n);this._defaults=s;this._name=r;this._init()}var r="singleUpload",i=t.document,s={maxWidth:320,maxHeight:180,minWidth:16,minHeight:16,previewImages:true,previewAsCanvas:true,isEmpty:true,nameable:false,deleteable:false,widget_name:null,filetypes:{audio:"Audio",archive:"Archive",html:"HTML",image:"Image","pdf-document":"PDF<br />Document","plain-text":"Plain<br />Text",presentation:"Presentation",spreadsheet:"Spreadsheet","text-document":"Text<br />Document",unknown:"Unknown<br />Filetype",video:"Video"}};o.prototype={_init:function(){var t=this;this.$widgetContainer=e("#"+this.element.id+"_widget_container");this.$addButton=this.$widgetContainer.find(".singleupload-buttonbar .add");this.$replaceButton=this.$widgetContainer.find(".singleupload-buttonbar .replace");this.$cancelButton=this.$widgetContainer.find(".singleupload-buttonbar .cancel");this.$deleteButton=this.$widgetContainer.find(".singleupload-buttonbar .delete");this.isDeletable=!this.options.isEmpty&&this.options.deleteable;if(this.options.deleteable){this.$deleteFlag=e("#"+this.element.id+"_delete")}if(this.isDeletable){this.$deleteButton.show()}this._resetInput();e(this.element).on("change",function(){t._onChange()});this.$cancelButton.click(function(){t._onCancel()});this.$deleteButton.click(function(){t._onDelete()})},_onChange:function(){var e=this.element.files[0];if(!e){this._onCancel();return}this.$cancelButton.removeClass("disabled").show("slide",{direction:"left"},"slow");if(this.isEmpty){this.$addButton.hide();this.$replaceButton.show()}if(this.isDeletable){this.$deleteButton.addClass("disabled").hide("slide",{direction:"right"},"slow")}this.options.previewImages&&this._isImage(e)?this._onPreviewImage():this._onPreviewFile()},_onCancel:function(){this.$cancelButton.addClass("disabled").hide("slide",{direction:"left"},"slow");if(this.isEmpty){this.$replaceButton.hide();this.$addButton.show()}if(this.isDeletable&&!this.isEmpty){this.$deleteButton.removeClass("disabled").show("slide",{direction:"right"},"slow")}var t=e("."+this.element.id+"_preview_image.active");var n=e("."+this.element.id+"_preview_image.download");if(t.hasClass("download"))return;if(this.options.nameable){t.find(".nameable").removeAttr("name");n.find(".nameable").removeAttr("disabled")}this._resetInput();n.slideDown({duration:"slow",queue:false,complete:function(){e(this).addClass("active")}});t.slideUp({duration:"slow",queue:false,complete:function(){e(this).remove()}})},_onDelete:function(){var t=this;var n=e("."+this.element.id+"_preview_image.download");if(!this.isDeletable)return;this.$replaceButton.hide();this.$addButton.show();this.$deleteButton.parent().addClass("removed").end();this.$deleteButton.addClass("disabled").hide("slide",{direction:"left",queue:false,complete:function(){t.$deleteButton.parent().remove()}},"slow");n.slideUp({duration:"slow",queue:false,complete:function(){e(this).empty()}});this.$deleteFlag.val(1);this.isDeletable=false;this.isEmpty=true},_onPreviewImage:function(){var n=this;var r=this.element.files[0];t.loadImage(r,function(t){var i=e("."+n.element.id+"_preview_image.active");var s=i.clone().empty().hide().removeClass("download").addClass("upload");if(n.options.nameable){i.find(".nameable").attr("disabled","disabled");var o=e("<div/>").addClass("row-fluid").html(e("<input/>").attr("type","text").addClass("nameable").attr("name",n.options.widget_name+"[name]").val(r.name))}else{var o=e("<div/>").addClass("row-fluid").text(r.name)}var u=e("<div/>").addClass("row-fluid").text(n._bytesToSize(r.size));s.appendTo(i.parent()).html(e(t).addClass("img-polaroid")).append(o).append(u);s.slideDown({duration:"slow",queue:false,complete:function(){e(this).addClass("active")}});i.slideUp({duration:"slow",queue:false,complete:function(){e(this).hasClass("download")?e(this).removeClass("active"):e(this).remove()}})},{maxWidth:n.options.maxWidth,maxHeight:n.options.maxHeight,minWidth:n.options.minWidth,minHeight:n.options.minHeight,canvas:n.options.previewAsCanvas,noRevoke:true})},_onPreviewFile:function(){var t=e("."+this.element.id+"_preview_image.active");var n=t.clone().empty().hide().removeClass("download").addClass("upload");var r=this.element.files[0];var i=this._checkFileType(r);var s=e("<div/>").addClass("fileicon").addClass(i).html(this.options.filetypes[i]);if(this.options.nameable){t.find(".nameable").attr("disabled","disabled");var o=e("<div/>").addClass("row-fluid").html(e("<input/>").attr("type","text").addClass("nameable").attr("name",this.options.widget_name+"[name]").val(r.name))}else{var o=e("<div/>").addClass("row-fluid").text(r.name)}var u=e("<div/>").addClass("row-fluid").text(this._bytesToSize(r.size));n.appendTo(t.parent()).html(s).append(o).append(u);n.slideDown({duration:"slow",queue:false,complete:function(){e(this).addClass("active")}});t.slideUp({duration:"slow",queue:false,complete:function(){e(this).hasClass("download")?e(this).removeClass("active"):e(this).remove()}})},_bytesToSize:function(e){var t=1024;var n=t*1024;var r=n*1024;var i=r*1024;if(e<t)return e+" B";else if(e<n)return(e/t).toFixed(2)+" KB";else if(e<r)return(e/n).toFixed(2)+" MB";else if(e<i)return(e/r).toFixed(2)+" GB";else return(e/i).toFixed(2)+" TB"},_checkFileType:function(e){if(this._isAudio(e))return"audio";if(this._isArchive(e))return"archive";if(this._isHTML(e))return"html";if(this._isImage(e))return"image";if(this._isPDFDocument(e))return"pdf-document";if(this._isPlainText(e))return"plain-text";if(this._isPresentation(e))return"presentation";if(this._isSpreadsheet(e))return"spreadsheet";if(this._isTextDocument(e))return"text-document";if(this._isVideo(e))return"video";return"unknown"},_isAudio:function(e){return this._isFileType(e,"audio/.*")},_isArchive:function(e){return this._isFileType(e,"application/.*compress.*")||this._isFileType(e,"application/.*archive.*")||this._isFileType(e,"application/.*zip.*")||this._isFileType(e,"application/.*tar.*")||this._isFileType(e,"application/x-ace")||this._isFileType(e,"application/x-bz2")||this._isFileType(e,"gzip/document")},_isHTML:function(e){return this._isFileType(e,"text/html")},_isImage:function(e){return this._isFileType(e,"image/.*")},_isPDFDocument:function(e){return this._isFileType(e,"application/acrobat")||this._isFileType(e,"applications?/.*pdf.*")||this._isFileType(e,"text/.*pdf.*")},_isPlainText:function(e){return this._isFileType(e,"text/plain")},_isPresentation:function(e){return this._isFileType(e,"application/.*ms-powerpoint.*")||this._isFileType(e,"application/.*officedocument.presentationml.*")||this._isFileType(e,"application/.*opendocument.presentation.*")},_isSpreadsheet:function(e){return this._isFileType(e,"application/.*ms-excel.*")||this._isFileType(e,"application/.*officedocument.spreadsheetml.*")||this._isFileType(e,"application/.*opendocument.spreadsheet.*")},_isTextDocument:function(e){return this._isFileType(e,"application/.*ms-?word.*")||this._isFileType(e,"application/.*officedocument.wordprocessingml.*")||this._isFileType(e,"application/.*opendocument.text.*")},_isVideo:function(e){return this._isFileType(e,"video/.*")},_isFileType:function(e,t){return e&&e.type.match(t)},_resetInput:function(){var t=e(this.element).val("").clone(true);e(this.element).replaceWith(t);this.element=t[0]}};e.fn[r]=function(t){var i=arguments;if(t===n||typeof t==="object"){return this.each(function(){if(!e.data(this,"plugin_"+r)){e.data(this,"plugin_"+r,new o(this,t))}})}else if(typeof t==="string"&&t[0]!=="_"&&t!=="init"){var s;this.each(function(){var n=e.data(this,"plugin_"+r);if(n instanceof o&&typeof n[t]==="function"){s=n[t].apply(n,Array.prototype.slice.call(i,1))}if(t==="destroy"){e.data(this,"plugin_"+r,null)}});return s!==n?s:this}}})(jQuery,window);